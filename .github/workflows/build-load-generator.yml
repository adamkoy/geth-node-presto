name: Build and Push Load Generator Image

on:
    push:
        branches: [infra-setup]
        paths:
            - "load-generator-image/**"
            - ".github/workflows/build-load-generator.yml"
    workflow_dispatch:
        inputs:
            environment:
                description: "Target environment (dev, stage, prod)"
                required: true
                default: "dev"
                type: choice
                options: ["dev", "stage", "prod"]
    workflow_call:
        inputs:
            environment:
                description: "Target environment (dev, stage, prod)"
                required: true
                type: string

env:
    # Full image reference, e.g. "your-user/geth-workload:latest" or "ghcr.io/owner/geth-workload:latest"
    WORKLOAD_IMAGE: "docker.io/adamkkk89/geth-workload:latest"

jobs:
    build-and-push:
        runs-on: ubuntu-latest
        # Use presto-<env> where env is an input on manual runs or workflow_call, otherwise dev
        environment: presto-${{ github.event_name == 'workflow_dispatch' && github.event.inputs.environment || github.event_name == 'workflow_call' && inputs.environment || 'dev' }}

        permissions:
            contents: read
            packages: write

        steps:
            - name: Checkout
              uses: actions/checkout@v4

            - name: Set up Docker Buildx
              uses: docker/setup-buildx-action@v3

            - name: Log in to container registry
              uses: docker/login-action@v3
              with:
                  registry: docker.io
                  username: ${{ secrets.DOCKER_USERNAME }}
                  password: ${{ secrets.DOCKER_SECRET }}

            - name: Build and push load generator image
              uses: docker/build-push-action@v5
              with:
                  context: ./load-generator-image
                  file: ./load-generator-image/Dockerfile.workload
                  push: true
                  # Build a multi-arch image so it can run on amd64 (EKS) and arm64 (Kind on Apple Silicon)
                  platforms: linux/amd64,linux/arm64
                  tags: ${{ env.WORKLOAD_IMAGE }}
