name: Terraform Deploy

on:
    pull_request:
        branches: [main]
    workflow_dispatch:
        inputs:
            apply:
                description: "Run terraform apply after plan?"
                required: true
                default: "false"
                type: choice
                options: ["false", "true"]
            environment:
                description: "Target environment (dev, stage, prod)"
                required: true
                default: "dev"
                type: choice
                options: ["dev", "stage", "prod"]
    workflow_call:
        inputs:
            apply:
                description: "Run terraform apply after plan?"
                required: true
                type: string
            environment:
                description: "Target environment (dev, stage, prod)"
                required: true
                type: string

permissions:
    id-token: write
    contents: read

env:
    AWS_REGION: ${{ secrets.AWS_REGION }}

jobs:
    terraform-plan:
        name: Terraform Plan
        runs-on: ubuntu-latest
        # Use presto-<env> where env is an input on manual runs, otherwise dev
        environment: presto-${{ github.event_name == 'workflow_dispatch' && github.event.inputs.environment || 'dev' }}

        steps:
            - name: Checkout
              uses: actions/checkout@v4

            - name: Configure AWS credentials from OIDC
              uses: aws-actions/configure-aws-credentials@v4
              with:
                  role-to-assume: ${{ secrets.AWS_ROLE_NAME }}
                  aws-region: ${{ env.AWS_REGION }}
                  role-session-name: GitHubActions-${{ github.run_id }}

            - name: Set up Terraform
              uses: hashicorp/setup-terraform@v3
              with:
                  terraform_version: 1.9.8

            - name: Terraform init
              working-directory: ./terraform
              run: terraform init -input=false

            - name: Terraform fmt
              working-directory: ./terraform
              run: terraform fmt -check

            - name: Terraform validate
              working-directory: ./terraform
              run: terraform validate

            - name: Terraform plan
              working-directory: ./terraform
              run: terraform plan -input=false

    terraform-apply:
        name: Terraform Apply
        runs-on: ubuntu-latest
        needs: terraform-plan
        if: github.event_name == 'workflow_dispatch' && github.event.inputs.apply == 'true'
        # Same environment name pattern as plan job
        environment: presto-${{ github.event_inputs.environment }}

        steps:
            - name: Checkout
              uses: actions/checkout@v4

            - name: Configure AWS credentials from OIDC
              uses: aws-actions/configure-aws-credentials@v4
              with:
                  role-to-assume: ${{ secrets.AWS_ROLE_NAME }}
                  aws-region: ${{ env.AWS_REGION }}
                  role-session-name: GitHubActions-${{ github.run_id }}

            - name: Set up Terraform
              uses: hashicorp/setup-terraform@v3
              with:
                  terraform_version: 1.9.8

            - name: Terraform init
              working-directory: ./terraform
              run: terraform init -input=false

            - name: Terraform apply
              working-directory: ./terraform
              run: terraform apply -input=false -auto-approve
